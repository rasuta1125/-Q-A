import type { OpenAIEmbeddingResponse, OpenAIChatResponse } from './types';

/**
 * OpenAI APIã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆã®åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ã‚’ç”Ÿæˆ
 */
export async function generateEmbedding(text: string, apiKey: string): Promise<number[]> {
  const response = await fetch('https://api.openai.com/v1/embeddings', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      model: 'text-embedding-3-small',
      input: text,
    }),
  });

  if (!response.ok) {
    throw new Error(`OpenAI API error: ${response.statusText}`);
  }

  const data: OpenAIEmbeddingResponse = await response.json();
  return data.data[0].embedding;
}

/**
 * OpenAI APIã‚’ä½¿ç”¨ã—ã¦å›ç­”ã‚’ç”Ÿæˆ
 */
export async function generateAnswer(
  query: string,
  context: string,
  tone: 'polite' | 'casual' | 'brief',
  apiKey: string
): Promise<string> {
  const systemPrompts = {
    polite: `ã‚ãªãŸã¯ãƒã‚«ãƒ­ãƒ‹ã‚¹ã‚¿ã‚¸ã‚ªã®ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚µãƒãƒ¼ãƒˆæ‹…å½“ã§ã™ã€‚ä»¥ä¸‹ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«å¾“ã£ã¦å›ç­”ã—ã¦ãã ã•ã„ï¼š

ã€é‡è¦ãªåˆ¶ç´„ã€‘
- **æä¾›ã•ã‚ŒãŸå‚è€ƒæƒ…å ±ã®ã¿ã‚’åŸºã«å›ç­”ã—ã¦ãã ã•ã„**
- **æ†¶æ¸¬ã‚„æ¨æ¸¬ã§å›ç­”ã™ã‚‹ã“ã¨ã¯çµ¶å¯¾ã«ç¦æ­¢ã§ã™**
- å‚è€ƒæƒ…å ±ã«ãªã„å†…å®¹ã«ã¤ã„ã¦ã¯ã€Œç¢ºèªãŒå¿…è¦ã§ã™ã€ã¨æ­£ç›´ã«ä¼ãˆã¦ãã ã•ã„
- ä¸æ˜ãªç‚¹ã¯æ±ºã—ã¦è‡ªå·±åˆ¤æ–­ã§è£œå®Œã—ãªã„ã§ãã ã•ã„

ã€å›ç­”ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
- ã‚„ã•ã—ã„æ•¬èªã§ã€Œã§ã™ãƒ»ã¾ã™ã€èª¿ã‚’ä½¿ç”¨
- å›ç­”ã¯ç®‡æ¡æ›¸ãã§æ•´ç†ã—ã€èª­ã¿ã‚„ã™ãæ§‹æˆ
- æ³¨æ„ç‚¹ã‚„æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚‚å«ã‚ã‚‹
- å›ºã„å®šå‹æ–‡ï¼ˆã€Œæ‰¿çŸ¥è‡´ã—ã¾ã—ãŸã€ç­‰ï¼‰ã¯é¿ã‘ã‚‹
- æ•°å€¤ã‚„æ—¥æ™‚ã¯å‚è€ƒæƒ…å ±ã‹ã‚‰æ­£ç¢ºã«å¼•ç”¨
- çµµæ–‡å­—ã¯ä½¿ç”¨ã—ãªã„
- æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã¯æ­£ç›´ã«ä¼ãˆã‚‹`,

    casual: `ã‚ãªãŸã¯ãƒã‚«ãƒ­ãƒ‹ã‚¹ã‚¿ã‚¸ã‚ªã®ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¹ã‚¿ãƒƒãƒ•ã§ã™ã€‚ä»¥ä¸‹ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«å¾“ã£ã¦å›ç­”ã—ã¦ãã ã•ã„ï¼š

ã€é‡è¦ãªåˆ¶ç´„ã€‘
- **æä¾›ã•ã‚ŒãŸå‚è€ƒæƒ…å ±ã®ã¿ã‚’åŸºã«å›ç­”ã—ã¦ãã ã•ã„**
- **æ†¶æ¸¬ã‚„æ¨æ¸¬ã§å›ç­”ã™ã‚‹ã“ã¨ã¯çµ¶å¯¾ã«ç¦æ­¢ã§ã™**
- å‚è€ƒæƒ…å ±ã«ãªã„å†…å®¹ã«ã¤ã„ã¦ã¯ã€Œç¢ºèªãŒå¿…è¦ã§ã™ã€ã¨æ­£ç›´ã«ä¼ãˆã¦ãã ã•ã„

ã€å›ç­”ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
- è¦ªã—ã¿ã‚„ã™ã„ã€Œã§ã™ãƒ»ã¾ã™ã€èª¿
- é©åº¦ã«ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ãªè¡¨ç¾ã‚’ä½¿ç”¨
- å›ç­”ã¯ç°¡æ½”ã«ã€è¦ç‚¹ã‚’ã¾ã¨ã‚ã‚‹
- çµµæ–‡å­—ã¯æ§ãˆã‚ã«ï¼ˆğŸ˜Šç¨‹åº¦ï¼‰
- æ•°å€¤ã‚„æ—¥æ™‚ã¯å‚è€ƒæƒ…å ±ã‹ã‚‰æ­£ç¢ºã«å¼•ç”¨`,

    brief: `ã‚ãªãŸã¯ãƒã‚«ãƒ­ãƒ‹ã‚¹ã‚¿ã‚¸ã‚ªã®ã‚µãƒãƒ¼ãƒˆæ‹…å½“ã§ã™ã€‚ã‚³ãƒ”ãƒšç”¨ã®ç°¡æ½”ãªå›ç­”ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š

ã€é‡è¦ãªåˆ¶ç´„ã€‘
- **æä¾›ã•ã‚ŒãŸå‚è€ƒæƒ…å ±ã®ã¿ã‚’åŸºã«å›ç­”ã—ã¦ãã ã•ã„**
- **æ†¶æ¸¬ã‚„æ¨æ¸¬ã¯çµ¶å¯¾ã«ç¦æ­¢ã§ã™**

ã€å›ç­”ã‚¹ã‚¿ã‚¤ãƒ«ã€‘
- æœ€ã‚‚é‡è¦ãªæƒ…å ±ã®ã¿ã‚’è¨˜è¼‰
- ç°¡æ½”ã«2-3æ–‡ã§å®Œçµ
- ä½™è¨ˆãªèª¬æ˜ã¯çœã
- ã€Œã§ã™ãƒ»ã¾ã™ã€èª¿
- çµµæ–‡å­—ãªã—`,
  };

  const response = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      model: 'gpt-4o-mini',
      messages: [
        {
          role: 'system',
          content: systemPrompts[tone],
        },
        {
          role: 'user',
          content: `ä»¥ä¸‹ã®æƒ…å ±ã‚’åŸºã«ã€ãŠå®¢æ§˜ã®å•ã„åˆã‚ã›ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚

ã€ãŠå®¢æ§˜ã®å•ã„åˆã‚ã›ã€‘
${query}

ã€å‚è€ƒæƒ…å ±ã€‘
${context}

ã€å›ç­”ã®æ³¨æ„äº‹é …ã€‘
1. ä¸Šè¨˜ã®å‚è€ƒæƒ…å ±ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹å†…å®¹ã®ã¿ã‚’ä½¿ã£ã¦å›ç­”ã—ã¦ãã ã•ã„
2. å‚è€ƒæƒ…å ±ã«ãªã„å†…å®¹ã«ã¤ã„ã¦ã¯ã€æ¨æ¸¬ã‚„æ†¶æ¸¬ã§è£œå®Œã›ãšã€Œã“ã®ç‚¹ã«ã¤ã„ã¦ã¯ç¢ºèªãŒå¿…è¦ã§ã™ã€ã¨æ˜è¨˜ã—ã¦ãã ã•ã„
3. ç­”ãˆã‚‰ã‚Œãªã„è³ªå•ã®å ´åˆã¯ã€æ­£ç›´ã«ã€Œç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ãŒã€ã“ã®è³ªå•ã«ãŠç­”ãˆã™ã‚‹æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¹ã‚¿ãƒƒãƒ•ã«ç›´æ¥ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€ã¨å›ç­”ã—ã¦ãã ã•ã„
4. æ•°å€¤ã€æ—¥ä»˜ã€æ–™é‡‘ãªã©ã¯å‚è€ƒæƒ…å ±ã‹ã‚‰æ­£ç¢ºã«å¼•ç”¨ã—ã¦ãã ã•ã„
5. è‡ªåˆ†ã®çŸ¥è­˜ã‚„ä¸€èˆ¬è«–ã‚’è¿½åŠ ã—ãªã„ã§ãã ã•ã„`,
        },
      ],
      temperature: 0.7,
      max_tokens: 800,
    }),
  });

  if (!response.ok) {
    throw new Error(`OpenAI API error: ${response.statusText}`);
  }

  const data: OpenAIChatResponse = await response.json();
  return data.choices[0].message.content;
}

/**
 * ä¿¡é ¼åº¦ã‚’åˆ¤å®š
 */
export function calculateConfidence(scores: number[]): 'A' | 'B' | 'C' {
  if (scores.length === 0) return 'C';

  const topScore = scores[0];
  const avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;

  // ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°åŸºæº–ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œç´¢ã‚’è€ƒæ…®ã—ã¦èª¿æ•´ï¼‰
  if (topScore >= 0.85) {
    return 'A'; // ãƒˆãƒƒãƒ—ã‚¹ã‚³ã‚¢ãŒé«˜ã‘ã‚Œã°ååˆ†ãªæ ¹æ‹ ã‚ã‚Š
  } else if (topScore >= 0.70 || (topScore >= 0.60 && avgScore >= 0.50)) {
    return 'B'; // è¦æ³¨æ„
  } else {
    return 'C'; // æƒ…å ±ä¸è¶³
  }
}

/**
 * ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ãƒ¡ãƒ¢ã‚’ç”Ÿæˆ
 */
export function getEscalationNote(confidence: 'A' | 'B' | 'C'): string | undefined {
  const notes = {
    A: undefined,
    B: 'âš ï¸ å‚è€ƒæƒ…å ±ã®ä¿¡é ¼åº¦ãŒä¸­ç¨‹åº¦ã§ã™ã€‚å¿µã®ãŸã‚æœ€æ–°æƒ…å ±ã‚’ç¤¾å†…ã§ç¢ºèªã—ã¦ã‹ã‚‰è¿”ä¿¡ã—ã¦ãã ã•ã„ã€‚',
    C: 'âŒ ååˆ†ãªæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ä»¥ä¸‹ã®ç‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š\nâ€¢ è©²å½“ã™ã‚‹Q&Aãƒ‡ãƒ¼ã‚¿ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹\nâ€¢ å•ã„åˆã‚ã›å†…å®¹ãŒå¯¾å¿œå¯èƒ½ãªç¯„å›²ã‹\nâ€¢ ç¤¾å†…ã®æ‹…å½“è€…ã«ç›´æ¥ç¢ºèªãŒå¿…è¦ã‹',
  };

  return notes[confidence];
}
