# マカロニスタジオ Q&A回答ツール

マカロニスタジオのスタッフ向けの社内用Q&A回答生成ツールです。問い合わせ内容を入力すると、AIが過去のQ&Aデータから最適な回答を生成します。

## プロジェクト概要

- **名前**: マカロニスタジオ Q&A回答ツール
- **目的**: スタッフが顧客からの問い合わせに迅速かつ正確に回答できるようサポート
- **主な機能**:
  - 問い合わせ内容からAIが回答を自動生成（RAG方式）
  - **検索優先順位: Q&A優先 → 不足時にWeb参照**
  - **AIの憶測禁止**: 参考情報にない内容は推測せず正直に回答
  - 3つの回答スタイル（丁寧・カジュアル・短文）
  - 信頼度判定とエスカレーション提案
  - Q&Aデータの登録・編集・管理
  - Webソースの登録・管理（URL自動取り込み）
  - 根拠情報の表示（参考元Q&A/Web、類似度スコア）

## URL

- **開発環境**: https://3000-izplhik1li78rvkilsey9-2b54fc91.sandbox.novita.ai
- **回答生成画面**: `/`
- **Q&A管理画面**: `/admin`
- **Web管理画面**: `/web-admin`
- **本番環境**: https://macaroni-qa-tool.pages.dev
- **GitHub**: https://github.com/rasuta1125/-Q-A

## 現在完了している機能

### ✅ 回答生成機能
- 問い合わせ内容を入力すると、AIが適切な回答を生成
- OpenAI GPT-4o-miniを使用した高品質な日本語回答
- RAG（Retrieval-Augmented Generation）方式で根拠に基づく回答生成
- **憶測禁止**: 参考情報に記載されている内容のみを使用
- **答えられない質問は正直に伝える**: 情報不足時は推測せず明確に回答

### ✅ 回答スタイル切替
- **丁寧（推奨）**: やさしい敬語、箇条書き、構造化された回答
- **カジュアル**: 親しみやすい「です・ます」調
- **短文（コピペ用）**: 最も重要な情報のみ2-3文で完結

### ✅ 信頼度判定
- **A (十分な根拠あり)**: トップスコア85%以上、平均75%以上
- **B (要注意)**: トップスコア70%以上、平均60%以上 → 社内確認推奨
- **C (情報不足)**: 十分な情報なし → 社内確認必須、回答生成なし

### ✅ エスカレーション機能
- 信頼度に応じて、社内確認を促す注意メッセージを表示
- 情報不足の場合、確認すべきチェックリストを提案

### ✅ 根拠表示（Q&A優先 → Web参照）
- 参考にした情報を最大3件表示
- **検索優先順位**:
  1. まずQ&Aデータから検索（最優先）
  2. Q&Aが不十分な場合、Webソースで補完
  3. Q&Aが見つからない場合、Webソースのみ使用
- Q&A: カテゴリ、質問、回答の抜粋、類似度スコア
- Web: タイトル、URL、コンテンツ抜粋、類似度スコア

### ✅ Q&A管理機能
- Q&Aの新規登録、編集、削除（論理削除）
- **Q&A一括インポート機能** - テキスト貼り付けで複数Q&Aを一括登録
- **CSVインポート機能（重複検出・選抜付き）** - LINE会話履歴から自動抽出
  - LINE Official Account形式の自動検出
  - 個人情報の自動除外（名前、電話、メール）
  - 質問の類似度判定（85%以上で重複検出）
  - 重複グループから最適バージョンを選択可能
  - カテゴリ・キーワードの自動推測
- カテゴリ分類（予約方法、料金、キャンセル、駐車場等）
- 優先度設定（高・中・低）
- 検索用キーワード登録
- 有効/無効フラグ

### ✅ データベース（Cloudflare D1）
- Q&Aアイテム管理（SQLite）
- Webソース管理（URL、タイトル、コンテンツ）
- ローカル開発環境対応（`--local`フラグ）
- マイグレーション管理
- サンプルQ&Aデータ15件登録済み

### ✅ Web取り込み機能
- URLを入力するだけで自動的にWebページを取得
- HTMLから本文コンテンツを抽出（タグ除去）
- D1データベースに保存
- Vectorize（ベクトル検索）に埋め込みベクトルを登録
- Web管理画面でURL登録・削除が可能

## 機能URI一覧

### フロントエンド
| パス | 説明 | メソッド |
|------|------|---------|
| `/` | 回答生成画面（メイン） | GET |
| `/admin` | Q&A管理画面 | GET |
| `/web-admin` | Web管理画面 | GET |

### API
| エンドポイント | 説明 | メソッド | パラメータ |
|---------------|------|---------|----------|
| `/api/generate` | AI回答生成（Q&A優先→Web参照） | POST | `{ query: string, tone: 'polite'\|'casual'\|'brief' }` |
| `/api/qa` | Q&A一覧取得 | GET | - |
| `/api/qa` | Q&A新規登録 | POST | `{ category, question, answer, keywords?, priority?, is_active? }` |
| `/api/qa/:id` | Q&A更新 | PUT | `{ category, question, answer, keywords?, priority?, is_active? }` |
| `/api/qa/:id` | Q&A削除（論理削除） | DELETE | - |
| `/api/qa/bulk-import` | Q&A一括インポート（テキスト/CSV両対応） | POST | `{ items: Array<{ category, question, answer, keywords?, priority?, is_active? }> }` |
| `/api/web` | Webソース一覧取得 | GET | - |
| `/api/web` | Webソース新規登録（URL自動取り込み） | POST | `{ url: string }` |
| `/api/web/:id` | Webソース削除 | DELETE | - |

## まだ実装されていない機能

### 🔜 Vectorize統合（ベクトル検索）
- 現在はキーワード検索でフォールバック対応
- 本番デプロイ時にCloudflare Vectorizeを使用した類似検索を実装予定
- OpenAI text-embedding-3-small（1536次元）で埋め込みベクトル生成

### 🔜 Web取り込み機能の拡張
- スケジュール自動更新（定期的にWebページを再取得）
- 複数URL一括登録
- サイトマップからの自動抽出

### 🔜 本番デプロイ
- Cloudflare Pagesへのデプロイ
- 環境変数（OPENAI_API_KEY）のシークレット設定
- 本番D1データベースの作成とマイグレーション
- Vectorizeインデックスの作成

## データアーキテクチャ

### データモデル

#### qa_items（Q&Aアイテム）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER | 主キー |
| category | TEXT | カテゴリ（予約方法、料金等） |
| question | TEXT | 質問 |
| answer | TEXT | 回答 |
| keywords | TEXT | 検索用キーワード（カンマ区切り） |
| priority | INTEGER | 優先度（1=高、2=中、3=低） |
| is_active | INTEGER | 有効フラグ（1=有効、0=無効） |
| last_updated | DATETIME | 最終更新日時 |
| created_at | DATETIME | 作成日時 |

#### web_sources（Webソース）
| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER | 主キー |
| url | TEXT | URL（ユニーク） |
| title | TEXT | タイトル |
| content | TEXT | コンテンツ |
| last_crawled | DATETIME | 最終クロール日時 |
| created_at | DATETIME | 作成日時 |

### ストレージサービス

- **Cloudflare D1**: SQLiteベースのグローバル分散データベース
  - Q&Aアイテムの保存
  - Webソース情報の保存
  - ローカル開発: `.wrangler/state/v3/d1`に自動作成

- **Cloudflare Vectorize**: ベクトル検索エンジン
  - OpenAI埋め込みベクトル（1536次元）の保存
  - コサイン類似度による検索
  - 本番デプロイ時に作成予定

- **OpenAI API**:
  - `text-embedding-3-small`: 埋め込みベクトル生成
  - `gpt-4o-mini`: 回答生成

### データフロー

1. **Q&A登録時**:
   ```
   フォーム入力 → D1に保存 → OpenAIで埋め込み生成 → Vectorizeに保存
   ```

2. **回答生成時（Q&A優先 → Web参照）**:
   ```
   問い合わせ入力 → OpenAIで埋め込み生成 → Vectorizeで類似検索
   → Q&Aから検索（最優先）
   → Q&A不足時: Webソースも検索して補完
   → 信頼度判定 → OpenAIで回答生成（憶測禁止）→ 根拠と共に表示
   ```

3. **フォールバック（Vectorize未対応時）**:
   ```
   問い合わせ入力 → D1でキーワード検索（bigram マッチング）
   → Q&A優先、不足時はWeb → 信頼度判定 
   → OpenAIで回答生成（憶測禁止）→ 根拠と共に表示
   ```

## 使い方

### スタッフ向け使い方

1. **回答生成画面（`/`）にアクセス**
2. **問い合わせ内容を入力または貼り付け**
3. **回答スタイルを選択**（通常は「丁寧（推奨）」）
4. **「AIで回答生成」ボタンをクリック**
5. **生成された回答を確認**:
   - 信頼度バッジを確認（A/B/C）
   - エスカレーション注意がある場合は従う
   - 根拠情報で内容の正確性を確認
6. **「コピー」ボタンで回答をコピー**
7. **外部のDM/メールに貼り付けて使用**

### 管理者向けQ&A管理

#### 個別登録
1. **Q&A管理画面（`/admin`）にアクセス**
2. **「新規追加」ボタンでQ&Aを登録**:
   - カテゴリを選択
   - 質問と回答を入力
   - 検索用キーワードを入力（カンマ区切り）
   - 優先度を設定
3. **既存Q&Aの編集**: 編集アイコンをクリック
4. **Q&Aの削除**: ゴミ箱アイコンをクリック（論理削除）

#### テキスト一括インポート
1. **Q&A管理画面（`/admin`）で「テキスト一括」ボタンをクリック**
2. **LINEや過去の問い合わせから整形したテキストを貼り付け**:
   ```
   カテゴリ: 料金
   質問: 平日割引はありますか?
   回答: はい、平日(月〜金)は¥3,000割引でご案内しております。
   キーワード: 平日割引,料金
   ---
   カテゴリ: 撮影時間
   質問: 朝一番の時間は何時からですか?
   回答: 朝は10:00から撮影開始が可能です。
   キーワード: 営業時間,朝
   ```
3. **「データを解析してプレビュー」をクリック**
4. **プレビューで内容を確認**
5. **「この内容で一括登録」をクリック**して完了

#### CSVインポート（重複検出付き）（NEW!）
1. **LINE Official Accountから会話履歴をCSVエクスポート**
2. **Q&A管理画面（`/admin`）で「CSVインポート」ボタンをクリック**
3. **CSVファイルを選択して「CSVを読み込んで重複チェック」**
4. **自動抽出されたQ&Aを確認**:
   - 個人情報は自動除外
   - 重複グループから最適バージョンを選択
   - ユニークなQ&Aは自動採用
5. **「選択した内容でインポート」をクリック**して完了

詳細は `CSV_IMPORT_GUIDE.md` を参照

### 管理者向けWeb管理

1. **Web管理画面（`/web-admin`）にアクセス**
2. **参照したいWebページのURLを入力**
3. **「追加」ボタンをクリック**
   - 自動的にWebページを取得
   - HTMLから本文を抽出
   - D1データベースに保存
   - Vectorizeに埋め込みベクトルを登録
4. **Webソースの削除**: ゴミ箱アイコンをクリック

## 登録済みQ&Aカテゴリ

- 予約方法
- 所要時間
- 対象年齢
- 料金・七五三
- 料金・スマッシュケーキ
- 料金・ミルクバス
- キャンセル
- 日程変更
- 納品
- レタッチ
- 駐車場
- 持ち物
- 家族撮影
- 衣装
- 非対応（お食い初め等）

## 推奨される次のステップ

1. **✅ 完了: 一括インポート機能を実装**
   - テキスト形式でのコピー&ペースト登録
   - プレビュー機能で登録前に内容を確認可能
   - 複数件のQ&Aを一度に登録できる

2. **✅ 完了: CSVインポート機能（重複検出・選抜付き）**
   - LINE Official Accountからの会話履歴を直接インポート
   - 個人情報の自動除外（プライバシー保護）
   - 質問の類似度判定で重複を自動検出（85%閾値）
   - 重複グループから最適バージョンを選択可能
   - カテゴリ・キーワードの自動推測

3. **🔄 進行中: Q&Aデータの充実**:
   - **LINE Official Accountから会話履歴をエクスポート**
   - CSVインポート機能を使って初期データを投入
   - 重複を選抜して高品質なQ&Aを構築
   - カテゴリの追加・調整
   - キーワードの最適化

3. **本番環境への本格デプロイ**:
   - Cloudflare APIキーの設定（完了）
   - 本番D1データベースの作成（完了）
   - 本番D1へのマイグレーション実行
   - 環境変数（OPENAI_API_KEY）のシークレット登録
   - 本番環境での動作確認

4. **運用とフィードバック**:
   - スタッフによる実際の使用テスト
   - 回答品質のフィードバック収集
   - 信頼度判定の閾値調整

5. **機能拡張**:
   - 回答履歴の保存機能
   - Q&A使用頻度の分析
   - より高度なWeb取り込み機能

6. **UIの改善**:
   - モバイル対応の最適化
   - ダークモード対応
   - アクセシビリティ向上

## デプロイ

### ローカル開発
```bash
# データベースマイグレーション
npm run db:migrate:local

# サンプルデータ投入
npx wrangler d1 execute macaroni-qa-db --local --file=./seed.sql

# ビルド
npm run build

# 開発サーバー起動
pm2 start ecosystem.config.cjs

# ログ確認
pm2 logs --nostream
```

### 本番デプロイ（未実施）
```bash
# Cloudflare APIキー設定
# → Deploy タブから設定

# Vectorizeインデックス作成
npx wrangler vectorize create macaroni-qa-index --dimensions=1536 --metric=cosine

# D1データベース作成
npx wrangler d1 create macaroni-qa-db

# wrangler.jsonc のdatabase_idを更新

# マイグレーション
npm run db:migrate:prod

# 環境変数（シークレット）設定
npx wrangler pages secret put OPENAI_API_KEY --project-name macaroni-qa-tool

# デプロイ
npm run deploy:prod
```

## 技術スタック

- **フロントエンド**: 
  - HTML + TailwindCSS + Vanilla JavaScript
  - Axios（HTTPクライアント）
  - Font Awesome（アイコン）

- **バックエンド**: 
  - Hono（軽量Webフレームワーク）
  - TypeScript
  - Cloudflare Workers/Pages

- **データベース**: 
  - Cloudflare D1（SQLite）
  - Cloudflare Vectorize（ベクトル検索）

- **AI**: 
  - OpenAI API（GPT-4o-mini、text-embedding-3-small）

- **開発ツール**: 
  - Vite（ビルドツール）
  - Wrangler（Cloudflare CLI）
  - PM2（プロセス管理）

## プロジェクト構造

```
webapp/
├── src/
│   ├── index.tsx          # メインアプリケーション（API + HTML）
│   ├── openai.ts          # OpenAI API統合
│   └── types.ts           # TypeScript型定義
├── public/
│   └── static/
│       ├── app.js         # 回答生成画面のJS
│       └── admin.js       # Q&A管理画面のJS
├── migrations/
│   └── 0001_initial_schema.sql  # DBスキーマ
├── .dev.vars              # ローカル環境変数（APIキー）
├── .gitignore             # Git除外設定
├── ecosystem.config.cjs   # PM2設定
├── wrangler.jsonc         # Cloudflare設定
├── package.json           # 依存関係とスクリプト
├── seed.sql               # サンプルデータ
└── README.md              # このファイル
```

## ステータス

- **開発環境**: ✅ 稼働中
- **本番環境**: ✅ デプロイ済み（データ投入待ち）
- **GitHub**: ✅ プッシュ済み
- **テキスト一括インポート**: ✅ 実装完了
- **CSVインポート（重複検出付き）**: ✅ 実装完了
- **LINE会話履歴対応**: ✅ 実装完了
- **最終更新**: 2025-10-28

---

**マカロニスタジオ Q&A回答ツール** - スタッフの業務効率化をAIでサポート
